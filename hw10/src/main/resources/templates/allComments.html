<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <title>Comments</title>
  <style type="text/css">
  .comments td {
              border: 10px solid blue;
          }
</style>
</head>
<body>
<script src="http://code.jquery.com/jquery-2.1.4.min.js"></script>
<div class="container" style="min-height: 500px">

    <div class="starter-template">
        <h1>Comments Form</h1>

        <div id="feedback"></div>

        <form class="form-horizontal" id="add-form">
            <div class="form-group form-group-lg">
                <label class="col-sm-2 control-label">CommentId</label>
                <div class="col-sm-10">
                    <input type="text" class="form-control" id="commentid"/>
                </div>
            </div>

            <div class="form-group form-group-lg">
            <label class="col-sm-2 control-label">Comment</label>
            <div class="col-sm-10">
            <input type="text" class="form-control" id="text"/>
            </div>
            </div>


                        <div class="form-group form-group-lg">
                        <label class="col-sm-2 control-label">Book ID</label>
                        <div class="col-sm-10">
                        <input type="text" class="form-control" id="bookId"/>
                        </div>
                        </div>



            <div class="form-group">
                <div class="col-sm-offset-2 col-sm-10">
                    <button type="submit" id="btn-add"
                            class="btn btn-primary btn-lg">add
                    </button>
                </div>
            </div>
        </form>

    </div>


    <table id="comments" border="5" bgcolor="#add8e6">
    <thead>
    <tr>
    <td>ID</td>
    <td>Comment</td>
    </tr>
</thead>
<tbody>

</tbody>


</table>

</div>

<script>
$(document).ready(function () {

    $("#add-form").submit(function (event) {

event.preventDefault();

        fire_ajax_submit();

    });

})
function fire_ajax_submit() {

    var comment = {
        commentid: $("#commentid").val(),
        text : $("#text").val(),
        bookId :  $("#bookId").val()
    }

    $("#btn-add").prop("disabled", true);

    $.ajax({
        type: "POST",
        contentType: "application/json",
        url: "/addcomment",
        data: JSON.stringify(comment),
        dataType: 'json',
        cache: false,
        timeout: 600000,
        success: function (data) {
            console.log("SUCCESS : ", data);
            showAllComments();
            $("#btn-add").prop("disabled", false);
        },
        error: function (error) {
                                       alert("Error" + error);
                                   }

    })

}

    function showAllComments() {
            $.get("/allcomments").done(function (comments) {
                $("#comments tbody").empty();
                comments.forEach(function (comment) {
                    $("#comments tbody").append(`
                        <tr>
                            <td>${comment.commentid}</td>
                            <td>${comment.text}</td>
                            <td><button style=" color: green" onclick="editComment(${comment.commentid})" >Edit</button></td>
                            <td><button style=" color: red"  onclick="deleteComment(${comment.commentid})">Delete</button></td>

                                       </tr>
                    `)
                });
            })
        }

        function deleteComment(id) {
                $.ajax({
                    url: '/deleteComment?id=' + id,
                    method: 'DELETE',
                           success: function() {
                               showAllComments();
                           },
                           error: function (error) {
                               alert(error);
                           }
                       })
         }

         function editComment(commentid) {
           alert("You are editing comment with id - " + ( commentid ));
           var t = document.getElementById('comments');
           var name = ($(t.rows[commentid].cells[1]).text());
           var newtext = window.prompt("Change text", name);

            var editedcomment = {
                commentid: commentid,
                text : newtext
            };

        $(t.rows[commentid].cells[1]).html(editedcomment.text);

           $.ajax({
               url:"/editcomment?id="+ commentid,
               method:"PUT",
               data: JSON.stringify(editedcomment),
               dataType: "json",
               contentType: "application/json",
               success:   function(){
                   console.log("SUCCESS : ", data);
                   alert("succesfully updated to "+ data.text);
                   showAllComments();
               }

            })

         }
</script>
</body>
</html>